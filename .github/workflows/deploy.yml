name: Auto Deploy to Production
'on':
  push:
    branches:
      - main
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
      - name: Install Dependencies
        run: npm ci
      - name: Build Project
        run: npm run build
      - name: Send email if build failed
        if: failure()
        run: |
          curl -X POST \
            https://api.sparkpost.com/api/v1/transmissions \
            -H "Authorization: ${{ secrets.SPARKPOST_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "content": {
                "from": {
                  "email": "${{ secrets.EMAIL_FROM }}"
                },
                "subject": "ðŸš¨ Build Failed - Client Hub AI",
                "html": "<h2>Build Failed - Client Hub AI</h2><p>Your CI build failed on branch: <strong>${{ github.ref_name }}</strong></p><p>Commit: <strong>${{ github.sha }}</strong></p><p>Author: <strong>${{ github.actor }}</strong></p><p>Please check <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">GitHub Actions logs</a> for details.</p>"
              },
              "recipients": [
                {
                  "address": {
                    "email": "${{ secrets.NOTIFICATION_EMAIL }}"
                  }
                }
              ]
            }'
  deploy-production:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: '${{ secrets.SSH_KEY }}'
      - name: Deploy to Server
        run: >
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{
          secrets.SSH_HOST }} << 'EOF'
            cd /var/www/clienthubai-client/ClientHubAI
            echo "Pulling latest code..."
            git pull origin main
            echo "Installing dependencies..."
            npm install
            echo "Building project..."
            npm run build
            echo "Restarting backend..."
            pm2 restart clienthubai-client
            echo "Reloading Nginx..."
            sudo systemctl reload nginx
            echo "Deployment complete!"
          EOF
      - name: Send email if deployment successful
        if: success()
        run: |
          curl -X POST \
            https://api.sparkpost.com/api/v1/transmissions \
            -H "Authorization: ${{ secrets.SPARKPOST_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "content": {
                "from": {
                  "email": "${{ secrets.EMAIL_FROM }}"
                },
                "subject": "âœ… Deployment Successful - Client Hub AI",
                "html": "<h2>Deployment Successful - Client Hub AI</h2><p>Your deployment to production completed successfully on branch: <strong>${{ github.ref_name }}</strong></p><p>Commit: <strong>${{ github.sha }}</strong></p><p>Author: <strong>${{ github.actor }}</strong></p><p>View <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">GitHub Actions logs</a> for details.</p>"
              },
              "recipients": [
                {
                  "address": {
                    "email": "${{ secrets.NOTIFICATION_EMAIL }}"
                  }
                }
              ]
            }'
      - name: Send email if deployment failed
        if: failure()
        run: |
          curl -X POST \
            https://api.sparkpost.com/api/v1/transmissions \
            -H "Authorization: ${{ secrets.SPARKPOST_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "content": {
                "from": {
                  "email": "${{ secrets.EMAIL_FROM }}"
                },
                "subject": "ðŸš¨ Deployment Failed - Client Hub AI",
                "html": "<h2>Deployment Failed - Client Hub AI</h2><p>Your deployment to production failed on branch: <strong>${{ github.ref_name }}</strong></p><p>Commit: <strong>${{ github.sha }}</strong></p><p>Author: <strong>${{ github.actor }}</strong></p><p>Please check <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">GitHub Actions logs</a> for details.</p>"
              },
              "recipients": [
                {
                  "address": {
                    "email": "${{ secrets.NOTIFICATION_EMAIL }}"
                  }
                }
              ]
            }'